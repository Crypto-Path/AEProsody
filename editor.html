<!DOCTYPE html>
<html>
  <head>
    <title>
        Prosody - Editor
    </title>
    <link rel="stylesheet" href="CSS/UI.css">
    <style>
        
        #map-editor {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            width: 20rem;
            margin-left: auto;
            margin-right: auto;
            background-color: rgba(0, 0, 0, 0.4);
            border: 1px solid #888;
            position: fixed;
            bottom:0%;
            transform: rotate(180deg);
        }
        
        #EditorContainer {
            width: 15%;
            height: 100%;
            margin: auto;
            background-color: rgba(0, 0, 0, 0.4);
            border: 1px solid #888;
            position: relative;
            
        }

        .grid-cell {
            border: 1px solid #ccc;
            margin-top: -2px;
        }

        .note {
            background-image: url("Sprites/Notes/Note_Hit_1.png");
            background-repeat: no-repeat;
            background-size: contain;
            background-position-x: center;
        }
        

        input {
            width: auto;
            height: 1.5625rem;
            border-radius: 0.625rem;
            font-size: 0.625rem;
        }

        

    </style>
  </head>
  <body>
    <div id="BGContainer" style="position:absolute; background-color: rgba(0, 0, 0, 0.5); z-index: -5; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <img id="BGDim" class="background" style="position: absolute; z-index: -7; margin: 0 auto; width: 100%; background-color: inherit;" src="Sprites/Background/Dim.png" />
        <img id="BGCenter" class="background" style="position: absolute; z-index: -8; margin: 0 auto; width: 80%;" src="Sprites/Background/Center.png" />
        <img id="BGPattern" class="background" style="position: absolute; z-index: -9; margin: 0 auto; width: 120%;" src="Sprites/Background/Pattern.png" />
        <img id="BGGradient" class="background" style="position: absolute; z-index: -10; margin: 0 auto; width: 100%;" src="Sprites/Background/Gradient.png" />
    </div>
    <div id="HitBar" style="width: 20rem; height: 0.5rem; background-color: rgba(226, 57, 49, 0.75); position:absolute; bottom: 0; margin-left: calc(50% - 9rem);">
    </div>
    <div id="EditorContainer">
        <div id="map-editor">
        </div>
    </div>
    <script> 
        // Get the map editor container
        const mapEditor = document.querySelector('#map-editor');
        let offsetY = 0;
        let offset
        let audio = 0;
        let mapLength = 0;
        let BPM = 0;

        let file;

        let Json = {
            "1": {
                "Name": "???",
                "Audio": "???",
                "SongArtist": "???",
                "Creator": "???",
                "BPM": 60,
                "BG": {
                    "BG":"Sprites/Background/BG.png",
                    "Gradient":"Sprites/Background/Gradient.png",
                    "Pattern":"Sprites/Background/Pattern.png",
                    "Center":"Sprites/Background/Center.png"
                },
                "4Rows": {
                    "Difficulty1": {
                        "Map Name": "???",
                        "Offset": 0,
                        "Notes":[[],[],[],[]]
                    }
                }
            }
        }

        // Toggle note placement on click
        function toggleNote(event) {
            const cell = event.target;
            cell.classList.toggle('note');
            const row = cell.getAttribute('data-row');
            const col = 3 - cell.getAttribute('data-col');
            console.log(`Note at row ${row}, column ${col} is ${cell.classList.contains('note') ? 'on' : 'off'}.`);
            cell.classList.contains('note') ? Json["1"]["4Rows"]["Difficulty1"]["Notes"][col].push(parseInt(row)/4) : Json["1"]["4Rows"]["Difficulty1"]["Notes"][col].pop(parseInt(row)/4);
            console.log(cell)

            Json["1"]["4Rows"]["Difficulty1"]["Notes"][col].sort(function(a, b){
                return a - b;
            });

            UpdateChartJson()
        }

        function UpdateChartJson() {
            try {
                Json["1"]["Audio"] = document.getElementById("MDPreAudio").value;
            } catch (error) { }
            Json["1"]["Name"] = document.getElementById("MDChartName").value;
            Json["1"]["SongArtist"] = document.getElementById("MDArtist").value;
            Json["1"]["Creator"] = document.getElementById("MDCreator").value;
            Json["1"]["BPM"] = document.getElementById("MDBPM").value;
            Json["1"]["4Rows"]["Difficulty1"]["Offset"] = document.getElementById("MDOffset").value;

            document.getElementById("OptionChartData").innerHTML = JSON.stringify(Json);
        }

        function play() {
            audio.play();
        }

        function pause() {
            audio.pause();
        }

        // Move the grid up or down on scroll
        document.addEventListener('scroll', function(event) {
            const deltaY = event.deltaY;
            offsetY += deltaY/BPM;
        });

        window.onload = function() {
            // Updates the game, basically the play
            function Update() {
                if (audio != null) {
                    //mapEditor.style.transform = `rotate(180deg) translateY(${(-audio.currentTime*BPM*4+BPM*offset)/16}rem)`;
                    mapEditor.style.bottom = `${(-audio.currentTime*468+BPM*offset*4)/16}rem`;
                    //document.getElementById("HitBar").style.transform = `translateY(${(audio.currentTime*BPM*4)/16}rem)`;
                }
            }
            setInterval(Update, 1000/240)
            if (!blob) {
                console.log('Your browser does not support Blob URLs :(');     
            }

            document.getElementById('MDAudio').addEventListener('change', function(event){
                document.getElementById('MDPreAudio').value = "Custom"
                console.log('change on input#file triggered');
                file = this.files[0],
                fileURL = blob.createObjectURL(file);
                console.log(file);
                console.log('File name: '+file.name);
                if (document.getElementById("MDChartName").value == "") {
                    document.getElementById("MDChartName").value = file.name
                }
                console.log('File type: '+file.type);
                console.log('File BlobURL: '+ fileURL);
                document.getElementById('audio').src = fileURL;
                setTimeout(() => {
                    ReloadChart();
                }, 100);
            });
            
            document.getElementById('MDPreAudio').addEventListener('change', function(){
                console.log(`${this.value}`);
                console.log('File name: '+this.value);
                file = this.value;
                fileURL = this.value;
                console.log('File type: mp3');
                document.getElementById('audio').src = this.value;

                switch (this.value.split('/')[1]) {
                    case "Inaji-The_Pathbreaking.mp3":
                            document.getElementById("MDChartName").value = "The Pathbreaking"
                            document.getElementById("MDBPM").value = 120;
                            BPM = 120;
                            document.getElementById("MDOffset").value = 2.07;
                            document.getElementById("MDArtist").value = "Inaji";
                        break;
                    case "Cyberspace Abyss.mp3":
                            document.getElementById("MDChartName").value = "Cyberspace Abyss"
                            document.getElementById("MDBPM").value = 170;
                            BPM = 170;
                            document.getElementById("MDOffset").value = 0;
                            document.getElementById("MDArtist").value = "Cyphe Mercury";
                        break;
                
                    default:
                        break;
                }
                setTimeout(() => {
                    ReloadChart();
                }, 100);
            });
        }

        document.body.onkeyup = function(e) {
            if (e.key == " " || e.code == "Space" || e.keyCode == 32 ) {
                if (!audio.paused) {
                    pause();
                    return;
                }
                play();
            }
        }

        addEventListener("wheel", (event) => {
            audio.currentTime += event.deltaY/50;
        });
        

        var blob = window.URL || window.webkitURL;
        
        function ReloadChart() {
            if (audio != 0) {
                pause()
            }
            audio = document.getElementById("audio");

            RemoveAllTiles();

            offset = document.getElementById("MDOffset").value;
            BPM = parseInt(document.getElementById("MDBPM").value);
            mapLength = audio.duration

            AppendTiles(BPM*mapLength);
            // Create the grid cells
        }

        function JsonToChart() {
            Json = JSON.parse(document.getElementById("OptionChartData").innerHTML)

            document.getElementById("MDChartName").value = Json["1"]["Name"];
            document.getElementById("MDArtist").value = Json["1"]["SongArtist"];
            document.getElementById("MDCreator").value = Json["1"]["Creator"];
            document.getElementById("MDBPM").value = Json["1"]["BPM"];
            document.getElementById("MDOffset").value = Json["1"]["4Rows"]["Difficulty1"]["Offset"];
            ReloadChart();

            LoadNotes(Json["1"]["4Rows"]["Difficulty1"]["Notes"])
        }

        function RemoveAllTiles() {
            var cells = document.getElementsByClassName('grid-cell');

            while(cells[0]) {
                cells[0].parentNode.removeChild(cells[0]);
            }
        }

        function AppendTiles(_AMNT) {
            for (let i = 0; i < _AMNT; i++) {
                const cell = document.createElement('div');
                cell.classList.add('grid-cell');
                cell.addEventListener('click', toggleNote);
                cell.setAttribute('data-row', Math.floor(i / 4));
                cell.setAttribute('data-col', i % 4);
                if (Math.floor(i / 4) % 4 === 0 ) {
                    cell.style.border = '1px solid #000';
                }
                mapEditor.appendChild(cell);
            }
            UpdateTileHeight(BPM)
        }

        function LoadNotes(_Rows) {
            for (let r = 0; r < _Rows.length; r++) {
                const rows = _Rows[r];
                for (let i = 0; i < rows.length; i++) {
                    const col = rows[i];
                    console.log()
                    //let tile = document.querySelectorAll("[data-row=" + rows + "],[data-col=" + col + "]")
                    //tile.classList.contains('note') ? 'on' : 'off';
                }
            }
        }

        function UpdateTileHeight(_BPM) {
            var _Tiles = document.getElementsByClassName("grid-cell");
            for (let i = 0; i < _Tiles.length; i++) {
                _Tiles[i].style.height = 7030/_BPM+"px"
                
            }
        }
        window.onkeydown = function(e) {
            switch (e.keyCode) {
                case 27: 
                    document.getElementById("ExitMenu").style.display = (document.getElementById("ExitMenu").style.display == "none") ? "block" : "none";
                    //location.href = 'index.html';
                    break
            
                default:
                    console.log(e.keyCode)
                    break;
            }
        }
    </script>
    <div id="MappingInfo" class = "UIContainer" style="width:20%; float: left;">
        <div id="Header">
            <p>
                Mapping
            </p>
        </div>
        <div class = "UIContainer">
            <div>
                <a>
                    MetaData:
                </a>
            </div>
            <label>Song: </label>

            <div class="UIContainer">
                <label for="songs">Pre-Songs:</label>

                <select id="MDPreAudio" name="songs" onchange="UpdateChartJson()" id="songs">
                    <option value="Custom">Custom</option>
                    <option value="Audio/Inaji-The_Pathbreaking.mp3">Inaji - The Pathbreaking</option>
                    <option value="Audio/Cyberspace Abyss.mp3">Cyphe Mercury - Cyberspace Abyss</option>
                </select>
                <input id="MDAudio" onchange="UpdateChartJson()" type="file" accept="audio/mp3"> <label>Not fully supported</label><br>
            </div>

            <label>Chart Title: </label>
            <input id="MDChartName" onchange="UpdateChartJson()" type="text"> <br>
            <label>BPM: </label>
            <input id="MDBPM" onchange="{ReloadChart(); UpdateChartJson()}" type="number" value="60"> <br>
            <label>Offset: </label>
            <input id="MDOffset" onchange="{ReloadChart(); UpdateChartJson()}" type="text"> <br>
            <label>Artist: </label>
            <input id="MDArtist" onchange="UpdateChartJson()" type="text"> <br>
            <label>Creator: </label>
            <input id="MDCreator" onchange="UpdateChartJson()" type="text"> <br>
        </div>
    </div>
    
    <div id="MappingData" class="UIContainer"  style="width:20%; float: right;">
        <div>
            <p>
                Map JSON:
            </p>
            <hr>
            Loading maps into editor not supported yet
        </div>
        <span id="OptionChartData" class="textarea" role="textbox">
            
        </span>
        <!--<button onclick="JsonToChart()">Load</button>-->
        <button onclick="{navigator.clipboard.writeText(getElementById('OptionChartData').innerHTML)}">Copy</button>
    </div>
    
    <audio id="audio" style="position: absolute; bottom: 0; left: 0; float: left;" controls></audio><br>
    
    <div id="ExitMenu" class="modal" style="display:none; position: absolute; width: 100%;">
        <div class="modal-content">
            <div class="UIContainer" style="background-color: rgba(0, 0, 0, 0.8); width: 97.5%;">
                <a>
                    Are you sure you want to exit?
                </a>
                <br>
                <p>
                    Press 'esc' to close this window.
                <br>
                    Make sure you copy your JSON code for your map and save it into a file so you don't lose it.
                <br>
                    Currently you can only load charts in the JSON expirimental features in the game
                </p>
                <div class="UIContainer" style="background-color: rgba(56, 56, 56, 0.4);">
                    <button onclick="{location.href = 'index.html'}" style=" width: 5rem; height: 3rem;">
                        Exit
                    </button>
                </div>
            </div>
        </div>
    </div>
  </body>
</html>